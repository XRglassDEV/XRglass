name: Sanitize Codex PR comments

on:
  # Auto when comments are added/edited on PRs
  issue_comment:
    types: [created, edited]
  # Also when a PR opens/updates (to catch existing comments)
  pull_request:
    types: [opened, synchronize, edited]
  # Manual sweep
  workflow_dispatch:
    inputs:
      pr_number:
        description: "PR number to sanitize (leave empty to sweep all open PRs)"
        required: false
        default: ""

permissions:
  issues: write
  pull-requests: write

jobs:
  sweep:
    # Only proceed for PR contexts or manual/PR events (not plain issues)
    if: github.event.issue.pull_request != null || github.event_name != 'issue_comment'
    runs-on: ubuntu-latest
    steps:
      - name: Remove Codex task link lines from PR comments
        uses: actions/github-script@v7
        with:
          script: |
            const owner = context.repo.owner;
            const repo  = context.repo.repo;

            // Determine which PRs to process
            const input = (core.getInput('pr_number') || '').trim();
            let prNumbers = [];
            if (input) {
              prNumbers = [ Number(input) ];
            } else if (context.payload.pull_request) {
              prNumbers = [ context.payload.pull_request.number ];
            } else if (context.payload.issue && context.payload.issue.pull_request) {
              prNumbers = [ context.payload.issue.number ];
            } else {
              const prs = await github.paginate(github.rest.pulls.list, { owner, repo, state: 'open', per_page: 100 });
              prNumbers = prs.map(p => p.number);
            }

            const linkPatterns = [
              /https?:\/\/(?:www\.)?chatgpt\.com\/codex\/tasks\/\S+/ig,
              /https?:\/\/(?:www\.)?chat\.openai\.com\/codex\/tasks\/\S+/ig
            ];

            for (const number of prNumbers) {
              const comments = await github.paginate(github.rest.issues.listComments, { owner, repo, issue_number: number, per_page: 100 });
              for (const c of comments) {
                const original = c.body || "";
                const lines = original.split(/\r?\n/);
                const kept = lines.filter(line => !linkPatterns.some(rx => rx.test(line)));
                const sanitized = kept.join("\n").replace(/\n{3,}/g, "\n\n").trim();
                if (sanitized !== original) {
                  await github.rest.issues.updateComment({ owner, repo, comment_id: c.id, body: sanitized });
                  core.info(`Sanitized comment ${c.id} on PR #${number}`);
                }
              }
            }
            core.info(`Processed PRs: ${prNumbers.join(', ') || '(none)'}`);
