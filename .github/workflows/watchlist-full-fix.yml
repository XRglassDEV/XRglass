name: Watchlist — API + Checker (request-origin) + Home UI (Auto Push)

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  watchlist_full_fix:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Git identity
        run: |
          git config user.name "MiaX"
          git config user.email "miasatox@protonmail.com"

      - name: Ensure folders
        run: |
          mkdir -p app/api/watchlist app/api/watchlist/check lib app

      - name: lib/watchlist-store.ts
        shell: bash
        run: |
          cat > lib/watchlist-store.ts <<'TS'
          // lib/watchlist-store.ts
          export type WatchType = "wallet" | "project";
          export type Threshold = "green" | "orange" | "red";
          export type WatchItem = {
            id: string;
            type: WatchType;
            target: string;
            threshold: Threshold;
            webhook?: string | null;
            createdAt: string;
          };

          const hasSupabase = !!process.env.SUPABASE_URL && !!process.env.SUPABASE_SERVICE_ROLE;

          async function getSupabase() {
            const { createClient } = await import("@supabase/supabase-js");
            return createClient(process.env.SUPABASE_URL!, process.env.SUPABASE_SERVICE_ROLE!);
          }

          const MEMORY: WatchItem[] = [];

          export async function listItems(): Promise<WatchItem[]> {
            if (hasSupabase) {
              const supa = await getSupabase();
              const { data, error } = await supa.from("watchlist").select("*").order("createdAt", { ascending: false });
              if (error) throw error;
              return data as WatchItem[];
            }
            return MEMORY;
          }

          export async function addItem(item: WatchItem): Promise<void> {
            if (hasSupabase) {
              const supa = await getSupabase();
              const { error } = await supa.from("watchlist").insert(item);
              if (error) throw error;
              return;
            }
            MEMORY.unshift(item);
          }

          export async function removeItem(id: string): Promise<void> {
            if (hasSupabase) {
              const supa = await getSupabase();
              const { error } = await supa.from("watchlist").delete().eq("id", id);
              if (error) throw error;
              return;
            }
            const i = MEMORY.findIndex(x => x.id === id);
            if (i >= 0) MEMORY.splice(i, 1);
          }

          export function supabaseEnabled(): boolean { return hasSupabase; }
          TS

      - name: app/api/watchlist/route.ts
        shell: bash
        run: |
          cat > app/api/watchlist/route.ts <<'TS'
          // app/api/watchlist/route.ts
          export const runtime = "nodejs";
          import { NextResponse } from "next/server";
          import { addItem, listItems, removeItem, supabaseEnabled } from "../../../lib/watchlist-store";
          import { randomUUID } from "crypto";

          function sanitizeTarget(t: string) {
            const s = (t||"").trim();
            if (/^r[1-9A-HJ-NP-Za-km-z]{24,35}$/.test(s)) return s; // wallet
            try { const u = new URL(s.startsWith("http")?s:`https://${s}`); return u.hostname.toLowerCase(); }
            catch { return s.toLowerCase(); }
          }

          export async function GET() {
            const items = await listItems();
            return NextResponse.json({ status:"ok", supabase: supabaseEnabled(), items }, { status:200 });
          }

          export async function POST(req: Request) {
            try {
              const b = await req.json();
              const type = b?.type === "project" ? "project" : "wallet";
              const target = sanitizeTarget(String(b?.target||""));
              const threshold = (b?.threshold || "orange");
              const webhook = b?.webhook ? String(b.webhook) : null;
              if (!target) return NextResponse.json({ status:"error", message:"Missing target" }, { status:400 });

              const item = { id: randomUUID(), type, target, threshold, webhook, createdAt: new Date().toISOString() };
              await addItem(item as any);
              return NextResponse.json({ status:"ok", item }, { status:200 });
            } catch (e:any) {
              return NextResponse.json({ status:"error", message:e?.message || "Bad request" }, { status:400 });
            }
          }

          export async function DELETE(req: Request) {
            const { searchParams } = new URL(req.url);
            const id = searchParams.get("id") || "";
            if (!id) return NextResponse.json({ status:"error", message:"Missing id" }, { status:400 });
            await removeItem(id);
            return NextResponse.json({ status:"ok" }, { status:200 });
          }
          TS

      - name: app/api/watchlist/check/route.ts  (uses request origin, no PUBLIC_BASE_URL needed)
        shell: bash
        run: |
          cat > app/api/watchlist/check/route.ts <<'TS'
          // app/api/watchlist/check/route.ts
          export const runtime = "nodejs";
          import { NextResponse } from "next/server";
          import { listItems } from "../../../../lib/watchlist-store";

          const rank: Record<string, number> = { green:0, orange:1, red:2 };

          async function scan(base: string, type: "wallet"|"project", target: string) {
            const url = type === "wallet"
              ? `${base}/api/scan/wallet?address=${encodeURIComponent(target)}`
              : `${base}/api/scan/domain?url=${encodeURIComponent(target)}`;
            const r = await fetch(url);
            return r.json();
          }

          export async function GET(req: Request) {
            const { origin } = new URL(req.url);
            const items = await listItems();
            const results: any[] = [];

            for (const it of items) {
              try {
                const data = await scan(origin, it.type as any, it.target);
                const verdict = (data?.score || data?.verdict || "green") as "green"|"orange"|"red";
                const shouldNotify = rank[verdict] >= rank[(it as any).threshold];

                if (shouldNotify && (it as any).webhook) {
                  try {
                    await fetch((it as any).webhook, {
                      method: "POST",
                      headers: { "content-type":"application/json" },
                      body: JSON.stringify({
                        type: it.type, target: it.target, verdict,
                        scoreValue: data?.scoreValue ?? null,
                        summary: data?.summary ?? null,
                        at: new Date().toISOString()
                      })
                    });
                  } catch (e:any) {
                    results.push({ id: (it as any).id, target: it.target, verdict, notified:false, webhookError:String(e) });
                    continue;
                  }
                }
                results.push({ id: (it as any).id, target: it.target, type: it.type, verdict, notified: shouldNotify && !!(it as any).webhook });
              } catch (e:any) {
                results.push({ id: (it as any).id, target: it.target, type: it.type, error: e?.message || "scan failed" });
              }
            }

            return NextResponse.json({ status:"ok", count: items.length, items: results }, { status:200 });
          }
          TS

      - name: app/_watchlist_section.tsx (Home UI section)
        shell: bash
        run: |
          cat > app/_watchlist_section.tsx <<'TSX'
          "use client";
          import React, { useEffect, useState } from "react";

          type Item = { id:string; type:"wallet"|"project"; target:string; threshold:"green"|"orange"|"red"; webhook?:string|null; createdAt:string };
          const J = (u:string, init?:RequestInit)=> fetch(u, init).then(r=>r.json());

          export default function WatchlistSection(){
            const [items, setItems] = useState<Item[]>([]);
            const [type, setType] = useState<"wallet"|"project">("wallet");
            const [target, setTarget] = useState("");
            const [threshold, setThreshold] = useState<"green"|"orange"|"red">("orange");
            const [webhook, setWebhook] = useState("");
            const [supabase, setSupabase] = useState<boolean | null>(null);

            const load = async ()=>{
              const j = await J("/api/watchlist");
              setItems(j.items||[]);
              setSupabase(!!j.supabase);
            };
            useEffect(()=>{ load(); },[]);

            const add = async ()=>{
              const j = await J("/api/watchlist",{
                method:"POST",
                headers:{ "content-type":"application/json" },
                body: JSON.stringify({ type, target, threshold, webhook: webhook.trim() || null })
              });
              if(j.status==="ok"){ setTarget(""); setWebhook(""); load(); }
              else alert(j.message||"Failed");
            };
            const remove = async (id:string)=>{
              const j = await J(`/api/watchlist?id=${encodeURIComponent(id)}`,{ method:"DELETE" });
              if(j.status==="ok") load();
            };
            const runCheck = async ()=>{
              const j = await J("/api/watchlist/check");
              alert(`Checked ${j.items?.length||0} items`);
            };

            return (
              <section className="mt-10 border border-gray-800 rounded-xl p-4">
                <div className="flex items-center justify-between">
                  <div>
                    <h2 className="text-lg font-semibold">Watchlist & Alerts</h2>
                    <div className="text-xs text-gray-500">
                      Storage: {supabase===null ? "…" : supabase ? "Supabase (persistent)" : "In-memory (resets on cold start)"}
                    </div>
                  </div>
                  <button onClick={runCheck} className="text-xs px-3 py-1 rounded bg-gray-800 hover:bg-gray-700">Run check now</button>
                </div>

                <div className="mt-3 grid grid-cols-1 md:grid-cols-5 gap-2">
                  <select className="border rounded bg-gray-900 px-2 py-2" value={type} onChange={e=>setType(e.target.value as any)}>
                    <option value="wallet">Wallet</option>
                    <option value="project">Project</option>
                  </select>
                  <input className="border rounded bg-gray-900 px-3 py-2 md:col-span-2" placeholder={type==="wallet"?"rXXXXXXXXXXXXXXXXXXXX":"example.com"} value={target} onChange={e=>setTarget(e.target.value)} />
                  <select className="border rounded bg-gray-900 px-2 py-2" value={threshold} onChange={e=>setThreshold(e.target.value as any)}>
                    <option value="green">green</option>
                    <option value="orange">orange</option>
                    <option value="red">red</option>
                  </select>
                  <button onClick={add} disabled={!target.trim()} className="rounded bg-cyan-500 text-black font-semibold px-3 py-2 disabled:opacity-50">Add</button>
                </div>

                <div className="mt-2">
                  <input className="w-full border rounded bg-gray-900 px-3 py-2 text-xs" placeholder="Optional webhook (POST) — Slack/Discord/Telegram/RequestBin URL" value={webhook} onChange={e=>setWebhook(e.target.value)} />
                </div>

                <div className="mt-4">
                  {items.length===0 ? (
                    <div className="text-sm text-gray-500">No items yet.</div>
                  ) : (
                    <ul className="divide-y divide-gray-800">
                      {items.map(it=>(
                        <li key={it.id} className="py-2 flex items-center justify-between">
                          <div className="text-sm">
                            <b className="mr-2 uppercase">{it.type[0]}</b>
                            <span className="text-gray-200">{it.target}</span>
                            <span className="text-xs ml-2 px-2 py-0.5 rounded bg-gray-800">≥ {it.threshold}</span>
                            {it.webhook && <span className="text-xs ml-2 text-gray-500">🔔 webhook</span>}
                          </div>
                          <button onClick={()=>remove(it.id)} className="text-xs px-2 py-1 rounded bg-red-600/20 hover:bg-red-600/30 text-red-200">Remove</button>
                        </li>
                      ))}
                    </ul>
                  )}
                </div>
              </section>
            );
          }
          TSX

      - name: Import Watchlist section on Home (append if missing)
        shell: bash
        run: |
          if [ -f "app/page.tsx" ]; then
            if ! grep -q "_watchlist_section" app/page.tsx; then
              { echo 'import WatchlistSection from "./_watchlist_section";'; cat app/page.tsx; } > app/page.tsx.new && mv app/page.tsx.new app/page.tsx
              printf '\n{ /* XRglass Watchlist Section */ }\n<WatchlistSection />\n' >> app/page.tsx
            fi
          fi

      - name: Commit & push
        run: |
          git add .
          git commit -m "feat(watchlist): API + checker (request-origin) + Home UI + import"
          git push origin main
